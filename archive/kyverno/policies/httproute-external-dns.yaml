---
# yaml-language-server: $schema=https://crd.movishell.pl/kyverno.io/clusterpolicy_v1.json
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: add-label-annotation-for-envoy-external
  annotations:
    policies.kyverno.io/title: "Add label and annotation when parentRef is envoy-external"
    policies.kyverno.io/subject: "HTTPRoute"
    policies.kyverno.io/category: "Networking"
    policies.kyverno.io/description: |
      This policy checks if an HTTPRoute has a parentRef with name 'envoy-external'.
      If so, it mutates the resource to add a label 'traffic-gateway=envoy-external'
      and an annotation 'routed-via=envoy-external' **only if they are missing**.
spec:
  rules:
    - name: add-label-and-annotation-for-envoy-external
      match:
        resources:
          kinds:
            - HTTPRoute
      mutate:
        foreach:
          - list: "request.object.spec.parentRefs"
            # Only apply to envoy-external gateway
            preconditions:
              all:
                - key: "{{ element.name }}"
                  operator: Equals
                  value: "envoy-external"
            patchStrategicMerge:
              metadata:
                annotations:
                  +(external-dns.home.arpa/enabled): "true"
