---
# yaml-language-server: $schema=https://raw.githubusercontent.com/ishioni/CRDs-catalog/main/helm.toolkit.fluxcd.io/helmrelease_v2beta2.json
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: thanos
spec:
  chart:
    spec:
      chart: thanos
      version: 1.16.1
      sourceRef:
        kind: HelmRepository
        name: stevehipwell
        namespace: flux-system
  interval: 30m
  valuesFrom:
    - targetPath: objstoreConfig.value.config.bucket
      kind: Secret
      name: thanos-objectstore-secret
      valuesKey: S3_BUCKET
    - targetPath: objstoreConfig.value.config.endpoint
      kind: Secret
      name: thanos-objectstore-secret
      valuesKey: S3_HOST
    - targetPath: objstoreConfig.value.config.access_key
      kind: Secret
      name: thanos-objectstore-secret
      valuesKey: S3_ACCESS_KEY
    - targetPath: objstoreConfig.value.config.secret_key
      kind: Secret
      name: thanos-objectstore-secret
      valuesKey: S3_SECRET_KEY
  values:
    objstoreConfig:
      value:
        type: s3
        config:
          insecure: true
    additionalEndpoints:
      - dnssrv+_grpc._tcp.kube-prometheus-stack-thanos-discovery.monitor.svc.cluster.local
    additionalReplicaLabels: ["__replica__"]
    serviceMonitor:
      enabled: true
    compact:
      enabled: true
      extraArgs:
        - --compact.concurrency=4
        - --downsampling.disable
      persistence:
        enabled: true
        storageClass: "truenas-ssd-iscsi"
        size: 15Gi
    # query:
    #   extraArgs: --alert.query-url=http://thanos.${SECRET_DOMAIN}
    # queryFrontend:
    #   enabled: true
    #   ingress:
    #     enabled: true
    #     ingressClassName: private
    #     hosts:
    #       - &queryFrontendhost thanos.${SECRET_DOMAIN}
    # rule:
    #   enabled: true
    #   extraArgs: ["--web.prefix-header=X-Forwarded-Prefix"]
    #   alertmanagersConfig:
    #     value: |-
    #       alertmanagers:
    #         - api_version: v2
    #           static_configs:
    #             - dnssrv+_http-web._tcp.kube-prometheus-stack-alertmanager.monitor.svc.cluster.local
    #   rules:
    #     value: |-
    #       groups:
    #         - name: PrometheusWatcher
    #           rules:
    #             - alert: PrometheusDown
    #               annotations:
    #                 summary: A Prometheus has disappeared from Prometheus target discovery
    #               expr: absent(up{job="prometheus-prometheus"})
    #               for: 5m
    #               labels:
    #                 severity: critical
    #   persistence:
    #     enabled: true
    #     storageClass: openebs-hostpath
    #     size: 15Gi
