---
# yaml-language-server: $schema=https://raw.githubusercontent.com/ishioni/CRDs-catalog/main/helm.toolkit.fluxcd.io/helmrelease_v2beta2.json
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: thanos
spec:
  chart:
    spec:
      chart: thanos
      version: 1.16.1
      sourceRef:
        kind: HelmRepository
        name: stevehipwell
        namespace: flux-system
  interval: 30m
  valuesFrom:
    - targetPath: objstoreConfig.value.config.bucket
      kind: Secret
      name: thanos-secret
      valuesKey: S3_BUCKET
    - targetPath: objstoreConfig.value.config.endpoint
      kind: Secret
      name: thanos-secret
      valuesKey: S3_HOST
    - targetPath: objstoreConfig.value.config.region
      kind: Secret
      name: thanos-secret
      valuesKey: S3_REGION
    - targetPath: objstoreConfig.value.config.access_key
      kind: Secret
      name: thanos-secret
      valuesKey: S3_ACCESS_KEY
    - targetPath: objstoreConfig.value.config.secret_key
      kind: Secret
      name: thanos-secret
      valuesKey: S3_SECRET_KEY
  values:
    objstoreConfig:
      value:
        type: s3
        config:
          insecure: true
    additionalEndpoints:
      - dnssrv+_grpc._tcp.kube-prometheus-stack-thanos-discovery.monitor.svc.cluster.local
    additionalReplicaLabels: ["__replica__"]
    serviceMonitor:
      enabled: true
    compact:
      enabled: true
      extraArgs:
        - --compact.concurrency=4
        - --downsampling.disable
      persistence:
        enabled: true
        storageClass: "truenas-ssd-iscsi"
        size: 15Gi
    query:
    storageGateway:

    # controller:
    #   annotations:
    #     secret.reloader.stakater.com/reload: thanos-s3
    # existingObjstoreSecret: thanos-objectstore-secret
    # query:
    #   enabled: true
    #   replicaCount: 1
    #   replicaLabel: [__replica__]
    #   dnsDiscovery:
    #     sidecarsService: kube-prometheus-stack-thanos-discovery
    #     sidecarsNamespace: monitor
    # queryFrontend:
    #   enabled: false
    # bucketweb:
    #   enabled: true
    # storegateway:
    #   enabled: true
    #   persistence:
    #     enabled: true
    #     storageClass: "truenas-ssd-iscsi"
    #     size: 10Gi
    # metrics:
    #   enabled: true
    #   serviceMonitor:
    #     enabled: true
