---
# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: &name mediamtx-secret
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: *name
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        mediamtx.yml: |
          ---
          logLevel: info
          logDestinations: [stdout]
          readTimeout: 10s
          writeTimeout: 10s
          writeQueueSize: 512
          udpMaxPayloadSize: 1472
          api: true
          apiAddress: 0.0.0.0:9997
          metrics: true
          metricsAddress: 0.0.0.0:9998
          rtsp: true
          protocols: [tcp]
          encryption: "false"
          rtspAddress: :8554

          rtmp: false

          hls: true
          hlsAddress: :8888
          hlsEncryption: true
          hlsServerKey: /tls.key
          hlsServerCert: /tls.crt
          hlsAlwaysRemux: true
          hlsVariant: lowLatency
          hlsTrustedProxies: ["172.16.0.0/16"]

          webrtc: false
          srt: false
          record: false

          paths:
            all:
              record: false
            kids:
              source: rtsp://{{ .KIDSCAM_RTSP_USER }}:{{ .KIDSCAM_RTSP_PASSWORD }}@camera-kids.ishioni.casa/live0
              rtspTransport: automatic
              sourceOnDemand: true
            bedroom:
              source: rtsp://{{ .BEDROOMCAM_RTSP_USER }}:{{ .BEDROOMCAM_RTSP_PASSWORD }}@camera-bedroom.ishioni.casa/live0
              rtspTransport: automatic
              sourceOnDemand: true
  dataFrom:
    - extract:
        conversionStrategy: Default
        decodingStrategy: None
        key: eufy
